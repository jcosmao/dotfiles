#!/bin/bash

function launch_ssh_agent ()
{
    ssh_agent_cmd="ssh-agent -s -t 36000"

    if [[ -f ~/.ssh-agent ]]; then
        eval "$(<~/.ssh-agent)" >/dev/null
    fi

    if env | grep -q SSH_AGENT_PID=; then
        cmd=$(ps ef --no-headers -o cmd $SSH_AGENT_PID)
        if [[ $ssh_agent_cmd != $cmd ]]; then
            kill $SSH_AGENT_PID &> /dev/null
        fi
    fi

    ssh-add -l &>/dev/null
    # Seems no ssh-agent running
    if [ "$?" == 2 ]; then
        # Try to export ssh-agent env
        (umask 066; ssh-agent -s -t 36000 > ~/.ssh-agent)
        eval "$(<~/.ssh-agent)" >/dev/null
    fi

    # Add default ssh-key to agent cache
    ssh-add 2> /dev/null
}
